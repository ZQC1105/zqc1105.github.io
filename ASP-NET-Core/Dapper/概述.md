在 .NET Core 中使用 Dapper 连接数据库的完整步骤如下：

## 1. **安装 NuGet 包**

```bash
dotnet add package Dapper
dotnet add package System.Data.SqlClient      # SQL Server
# 或者
dotnet add package Microsoft.Data.SqlClient   # 推荐，SQL Server 新版
# 或者
dotnet add package Npgsql                     # PostgreSQL
dotnet add package MySql.Data                 # MySQL
dotnet add package Oracle.ManagedDataAccess.Core  # Oracle
```

## 2. **配置数据库连接字符串**

**appsettings.json:**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=YourDb;User Id=sa;Password=YourPassword;TrustServerCertificate=true;"
    // SQLite: "Data Source=app.db"
    // PostgreSQL: "Host=localhost;Database=YourDb;Username=postgres;Password=YourPassword"
    // MySQL: "Server=localhost;Database=YourDb;Uid=root;Pwd=YourPassword"
  }
}
```

## 3. **基本连接和查询示例**

### **方式一：简单直接连接**

```csharp
using System.Data;
using Dapper;
using Microsoft.Data.SqlClient;

public class UserRepository
{
    private readonly string _connectionString;
    
    public UserRepository(IConfiguration configuration)
    {
        _connectionString = configuration.GetConnectionString("DefaultConnection");
    }
    
    public async Task<User> GetUserByIdAsync(int id)
    {
        using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync();
        
        var sql = "SELECT * FROM Users WHERE Id = @Id";
        var user = await connection.QueryFirstOrDefaultAsync<User>(sql, new { Id = id });
        
        return user;
    }
    
    public async Task<IEnumerable<User>> GetAllUsersAsync()
    {
        using var connection = new SqlConnection(_connectionString);
        return await connection.QueryAsync<User>("SELECT * FROM Users");
    }
}
```

### **方式二：使用依赖注入（推荐）**

**Program.cs 或 Startup.cs:**
```csharp
// .NET 6+ Program.cs
var builder = WebApplication.CreateBuilder(args);

// 注册数据库连接
builder.Services.AddScoped<IDbConnection>(sp => 
    new SqlConnection(builder.Configuration.GetConnectionString("DefaultConnection")));

// 或者注册自己的 Repository
builder.Services.AddScoped<IUserRepository, UserRepository>();

var app = builder.Build();
```

**Repository 类:**
```csharp
using System.Data;
using Dapper;

public interface IUserRepository
{
    Task<User> GetUserByIdAsync(int id);
    Task<IEnumerable<User>> GetAllUsersAsync();
}

public class UserRepository : IUserRepository
{
    private readonly IDbConnection _db;
    
    public UserRepository(IDbConnection db)
    {
        _db = db;
    }
    
    public async Task<User> GetUserByIdAsync(int id)
    {
        var sql = "SELECT * FROM Users WHERE Id = @Id";
        return await _db.QueryFirstOrDefaultAsync<User>(sql, new { Id = id });
    }
    
    public async Task<IEnumerable<User>> GetAllUsersAsync()
    {
        return await _db.QueryAsync<User>("SELECT * FROM Users");
    }
}
```

## 4. **常用 Dapper 操作方法**

```csharp
public class ProductRepository
{
    private readonly IDbConnection _db;
    
    // 查询单个
    public async Task<Product> GetProductAsync(int id)
    {
        return await _db.QueryFirstOrDefaultAsync<Product>(
            "SELECT * FROM Products WHERE Id = @Id", 
            new { Id = id });
    }
    
    // 查询多个
    public async Task<IEnumerable<Product>> GetProductsByCategoryAsync(int categoryId)
    {
        return await _db.QueryAsync<Product>(
            "SELECT * FROM Products WHERE CategoryId = @CategoryId", 
            new { CategoryId = categoryId });
    }
    
    // 插入数据（返回自增ID）
    public async Task<int> InsertProductAsync(Product product)
    {
        var sql = @"INSERT INTO Products (Name, Price, CategoryId) 
                    VALUES (@Name, @Price, @CategoryId);
                    SELECT CAST(SCOPE_IDENTITY() as int)";
        
        return await _db.ExecuteScalarAsync<int>(sql, product);
    }
    
    // 更新数据
    public async Task<int> UpdateProductAsync(Product product)
    {
        var sql = @"UPDATE Products 
                    SET Name = @Name, Price = @Price, CategoryId = @CategoryId
                    WHERE Id = @Id";
        
        return await _db.ExecuteAsync(sql, product);
    }
    
    // 删除数据
    public async Task<int> DeleteProductAsync(int id)
    {
        return await _db.ExecuteAsync(
            "DELETE FROM Products WHERE Id = @Id", 
            new { Id = id });
    }
    
    // 执行存储过程
    public async Task<IEnumerable<Report>> GetSalesReportAsync(DateTime startDate, DateTime endDate)
    {
        return await _db.QueryAsync<Report>(
            "sp_GetSalesReport", 
            new { StartDate = startDate, EndDate = endDate },
            commandType: CommandType.StoredProcedure);
    }
    
    // 事务处理
    public async Task<bool> TransferFundsAsync(int fromId, int toId, decimal amount)
    {
        using var transaction = _db.BeginTransaction();
        try
        {
            // 扣款
            await _db.ExecuteAsync(
                "UPDATE Accounts SET Balance = Balance - @Amount WHERE Id = @Id",
                new { Id = fromId, Amount = amount }, 
                transaction);
            
            // 存款
            await _db.ExecuteAsync(
                "UPDATE Accounts SET Balance = Balance + @Amount WHERE Id = @Id",
                new { Id = toId, Amount = amount }, 
                transaction);
            
            transaction.Commit();
            return true;
        }
        catch
        {
            transaction.Rollback();
            throw;
        }
    }
}
```

## 5. **高级功能示例**

```csharp
// 多结果集查询
public async Task<(User user, IEnumerable<Order> orders)> GetUserWithOrdersAsync(int userId)
{
    using var multi = await _db.QueryMultipleAsync(
        "SELECT * FROM Users WHERE Id = @Id; SELECT * FROM Orders WHERE UserId = @Id",
        new { Id = userId });
    
    var user = await multi.ReadFirstOrDefaultAsync<User>();
    var orders = await multi.ReadAsync<Order>();
    
    return (user, orders);
}

// 多表查询（一对一）
public async Task<UserDetail> GetUserDetailAsync(int id)
{
    var sql = @"
        SELECT u.*, p.*
        FROM Users u
        LEFT JOIN Profiles p ON u.Id = p.UserId
        WHERE u.Id = @Id";
    
    return await _db.QueryAsync<User, Profile, UserDetail>(
        sql,
        (user, profile) => new UserDetail 
        { 
            User = user, 
            Profile = profile 
        },
        new { Id = id },
        splitOn: "Id"  // 分割列
    ).FirstOrDefault();
}

// 分页查询
public async Task<(IEnumerable<Product> products, int totalCount)> GetProductsPagedAsync(
    int page, int pageSize, string searchTerm = "")
{
    var sql = @"
        SELECT *, COUNT(*) OVER() AS TotalCount
        FROM Products 
        WHERE (@SearchTerm IS NULL OR Name LIKE '%' + @SearchTerm + '%')
        ORDER BY Id
        OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY";
    
    var parameters = new 
    { 
        SearchTerm = string.IsNullOrEmpty(searchTerm) ? null : searchTerm,
        Offset = (page - 1) * pageSize,
        PageSize = pageSize
    };
    
    var result = await _db.QueryAsync<Product>(sql, parameters);
    var totalCount = result.FirstOrDefault()?.TotalCount ?? 0;
    
    return (result, totalCount);
}
```

## 6. **最佳实践建议**

1. **使用参数化查询**防止 SQL 注入
2. **异步操作**：使用 `QueryAsync`, `ExecuteAsync` 等方法
3. **连接管理**：确保连接正确关闭（使用 `using` 语句）
4. **错误处理**：添加适当的异常处理
5. **性能考虑**：对于批量操作考虑使用 Dapper 的 `Execute` 方法

## 7. **完整项目结构示例**

```
MyProject/
├── Models/
│   ├── User.cs
│   └── Product.cs
├── Repositories/
│   ├── Interfaces/
│   │   └── IUserRepository.cs
│   ├── UserRepository.cs
│   └── ProductRepository.cs
├── Services/
├── appsettings.json
└── Program.cs
```

这样设置可以确保你的 Dapper 连接既安全又高效！