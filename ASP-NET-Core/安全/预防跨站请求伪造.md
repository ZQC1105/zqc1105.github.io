# ASP.NET Core 防 CSRF 攻击最佳实践

> 一句话：所有能改数据的请求（POST/PUT/DELETE/PATCH）都必须带 **Anti-forgery Token**，ASP.NET Core 会替你验签；GET 请求禁止改数据。

---

## 1 原理速览

| 攻击方式 | 防御模式 |
| --- | --- |
| 利用已登录身份，诱导浏览器发恶意请求 | **同步器令牌（Synchronizer Token）**<br>服务器→页面植入一次性令牌→回传验证 |

---

## 2 Razor Pages & MVC 用法

### 2.1 Razor Pages（默认已开）

```html
<!-- 写法 1：Tag Helper 自动输出令牌 -->
<form method="post" asp-antiforgery="true">
  ...
</form>

<!-- 写法 2：手动（兼容旧代码） -->
<form method="post">
  @Html.AntiForgeryToken()
  ...
</form>
```

> Razor Pages 的 **OnPost*** 处理程序**自动验证**，无需加任何特性。

### 2.2 MVC

**视图**  
同上，确保表单里出现 `@Html.AntiForgeryToken()`。

**控制器**  
```csharp
[HttpPost]
[ValidateAntiForgeryToken]   // ← 手动开启验证
public IActionResult ChangePassword(ChangePasswordModel m) { ... }
```

---

## 3 AJAX / Fetch 请求

### 3.1 把令牌打到页面

```html
<meta name="xsrf-token" content="@Html.AntiForgeryTokenValue()" />
```

> `AntiForgeryTokenValue()` 是自定义扩展，见下方。

### 3.2 发请求时带 Header

```javascript
const xsrf = document.querySelector("meta[name='xsrf-token']").content;

fetch('/api/change-password', {
  method: 'POST',
  headers: {
    'RequestVerificationToken': xsrf, // ASP.NET Core 默认读取此头
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
});
```

### 3.3 自定义扩展方法（一次性复制）

```csharp
public static class HtmlExtensions
{
    public static string AntiForgeryTokenValue(this IHtmlHelper html)
    {
        var af = html.ViewContext.HttpContext.RequestServices.GetService<IAntiforgery>();
        return af?.GetAndStoreTokens(html.ViewContext.HttpContext).RequestToken ?? string.Empty;
    }
}
```

---

## 4 全局配置（可选）

```csharp
builder.Services.AddAntiforgery(o =>
{
    o.Cookie.Name = "X-CSRF-TOKEN";
    o.HeaderName = "X-CSRF-TOKEN";   // 可改名
    o.FormFieldName = "__RequestVerificationToken";
});
```

---

## 5 安全检查表

| 检查项 | 要求 |
| --- | --- |
| 状态变更端点 | 必须 `[ValidateAntiForgeryToken]` 或 Razor Pages 默认 |
| GET 请求 | **禁止**改数据，无需令牌 |
| 纯 API（JWT） | 用 `SameSite`+`CORS`+`Authorization` 头，通常 **不开** Anti-forgery |
| Cookie 认证 | 仍需要 Anti-forgery |
| SameSite | 至少 `Lax`（Core 默认已设） |
| 多标签页 | 令牌过期可刷新页面或静默重新获取 |

---

## 6 临时禁用（不推荐）

```csharp
[HttpPost]
[IgnoreAntiforgeryToken]   // 仅用于 Webhook 等无状态接口
public IActionResult Webhook() { ... }
```

---

## 7 速记口诀

> “**POST 必带 Token，GET 不改数据，API 看认证，Cookie 必配 SameSite。**”

照做即可在 ASP.NET Core 里彻底关闭 CSRF 攻击面。