åœ¨ EF Core ä¸­ä¸ä½¿ç”¨å¤–é”®å’Œå¯¼èˆªå±æ€§ï¼Œä½†ä½¿ç”¨ç´¢å¼•å…³è”è¡¨æ—¶ï¼Œä½ éœ€è¦**æ‰‹åŠ¨è¿›è¡Œå…³è”æŸ¥è¯¢**ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å®ç°æ–¹å¼ï¼š

## ğŸ“Œ **åœºæ™¯è®¾å®š**
å‡è®¾æœ‰ä¸¤ä¸ªè¡¨ï¼š
```csharp
// ä¸»è¡¨
public class Order
{
    public int Id { get; set; }           // ä¸»é”®
    public string OrderNo { get; set; }
    // æ²¡æœ‰å¯¼èˆªå±æ€§åˆ° OrderDetail
}

// å­è¡¨
public class OrderDetail
{
    public int Id { get; set; }
    public int OrderId { get; set; }      // ç´¢å¼•å…³è”ï¼Œä½†ä¸æ˜¯å¤–é”®
    public string ProductName { get; set; }
    // æ²¡æœ‰å¯¼èˆªå±æ€§åˆ° Order
}
```

## ğŸ” **æŸ¥è¯¢æ–¹æ³•æ±‡æ€»**

### **æ–¹æ³•1ï¼šç›´æ¥ä½¿ç”¨ LINQ Joinï¼ˆæ¨èï¼‰**
```csharp
// æŸ¥è¯¢å•ä¸ªè®¢å•åŠå…¶æ˜ç»†
public async Task<OrderWithDetailsDto> GetOrderWithDetails(int orderId)
{
    var result = await context.Orders
        .Where(o => o.Id == orderId)
        .Join(
            context.OrderDetails,
            order => order.Id,          // ä¸»è¡¨å…³è”é”®
            detail => detail.OrderId,   // å­è¡¨å…³è”é”®
            (order, detail) => new { order, detail }
        )
        .GroupBy(x => x.order)         // æŒ‰è®¢å•åˆ†ç»„
        .Select(g => new OrderWithDetailsDto
        {
            Order = g.Key,
            Details = g.Select(x => x.detail).ToList()
        })
        .FirstOrDefaultAsync();
    
    return result;
}

// DTOç±»
public class OrderWithDetailsDto
{
    public Order Order { get; set; }
    public List<OrderDetail> Details { get; set; }
}
```

### **æ–¹æ³•2ï¼šåˆ†åˆ«æŸ¥è¯¢å†ç»„åˆï¼ˆç®€å•æ¸…æ™°ï¼‰**
```csharp
public async Task<OrderWithDetailsDto> GetOrderWithDetailsSimple(int orderId)
{
    // æŸ¥è¯¢ä¸»è¡¨æ•°æ®
    var order = await context.Orders
        .FirstOrDefaultAsync(o => o.Id == orderId);
    
    if (order == null) return null;
    
    // æŸ¥è¯¢å­è¡¨æ•°æ®
    var details = await context.OrderDetails
        .Where(d => d.OrderId == orderId)
        .ToListAsync();
    
    return new OrderWithDetailsDto
    {
        Order = order,
        Details = details
    };
}
```

### **æ–¹æ³•3ï¼šä½¿ç”¨ FromSqlRaw è‡ªå®šä¹‰ SQL**
```csharp
public async Task<OrderWithDetailsDto> GetOrderWithDetailsSql(int orderId)
{
    var sql = @"
        SELECT o.*, d.*
        FROM Orders o
        LEFT JOIN OrderDetails d ON o.Id = d.OrderId
        WHERE o.Id = {0}
        ORDER BY d.Id";
    
    var items = await context.Set<OrderDetailJoinResult>()
        .FromSqlRaw(sql, orderId)
        .ToListAsync();
    
    if (!items.Any()) return null;
    
    // æ‰‹åŠ¨åˆ†ç»„
    var order = new Order
    {
        Id = items.First().OrderId,
        OrderNo = items.First().OrderNo
    };
    
    var details = items.Select(item => new OrderDetail
    {
        Id = item.DetailId,
        OrderId = item.OrderId,
        ProductName = item.ProductName
    }).ToList();
    
    return new OrderWithDetailsDto { Order = order, Details = details };
}

// ç”¨äºæ¥æ”¶è¿æ¥æŸ¥è¯¢ç»“æœçš„ä¸´æ—¶ç±»
public class OrderDetailJoinResult
{
    public int OrderId { get; set; }
    public string OrderNo { get; set; }
    public int DetailId { get; set; }
    public string ProductName { get; set; }
}
```

### **æ–¹æ³•4ï¼šä½¿ç”¨ Include æ›¿ä»£æ–¹æ¡ˆ**
è™½ç„¶ä¸èƒ½ç›´æ¥ç”¨ Includeï¼Œä½†å¯ä»¥é€šè¿‡ Select æŠ•å½±å®ç°ç±»ä¼¼æ•ˆæœï¼š
```csharp
public async Task<OrderWithDetailsProjection> GetOrderWithProjection(int orderId)
{
    var query = context.Orders
        .Where(o => o.Id == orderId)
        .Select(o => new OrderWithDetailsProjection
        {
            Order = o,
            Details = context.OrderDetails
                .Where(d => d.OrderId == o.Id)
                .ToList()
        });
    
    return await query.FirstOrDefaultAsync();
}

public class OrderWithDetailsProjection
{
    public Order Order { get; set; }
    public List<OrderDetail> Details { get; set; }
}
```

## ğŸš€ **æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šå•æ¬¡æŸ¥è¯¢è¿”å›æ‰€æœ‰æ•°æ®**
```csharp
public async Task<(Order Order, List<OrderDetail> Details)> GetOrderWithDetailsOptimized(int orderId)
{
    // å•æ¬¡æŸ¥è¯¢ï¼Œå‡å°‘æ•°æ®åº“å¾€è¿”
    var query = from o in context.Orders
                where o.Id == orderId
                select new
                {
                    Order = o,
                    Details = (from d in context.OrderDetails
                              where d.OrderId == o.Id
                              select d).ToList()
                };
    
    var result = await query.FirstOrDefaultAsync();
    return (result?.Order, result?.Details ?? new List<OrderDetail>());
}
```

### **æ–¹æ¡ˆ2ï¼šæ‰¹é‡æŸ¥è¯¢å¤šä¸ªè®¢å•**
```csharp
public async Task<Dictionary<int, List<OrderDetail>>> GetOrdersWithDetails(List<int> orderIds)
{
    // 1. è·å–æ‰€æœ‰è®¢å•
    var orders = await context.Orders
        .Where(o => orderIds.Contains(o.Id))
        .ToListAsync();
    
    // 2. æ‰¹é‡è·å–æ‰€æœ‰æ˜ç»†
    var allDetails = await context.OrderDetails
        .Where(d => orderIds.Contains(d.OrderId))
        .ToListAsync();
    
    // 3. åœ¨å†…å­˜ä¸­åˆ†ç»„ï¼ˆæ•°æ®é‡ä¸å¤§æ—¶ï¼‰
    var detailsByOrderId = allDetails
        .GroupBy(d => d.OrderId)
        .ToDictionary(g => g.Key, g => g.ToList());
    
    return detailsByOrderId;
}
```

## ğŸ”§ **é…ç½®ç´¢å¼•å…³è”ï¼ˆè™½ç„¶æ²¡æœ‰å¤–é”®ï¼‰**
```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // ä¸º OrderDetail.OrderId åˆ›å»ºç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
    modelBuilder.Entity<OrderDetail>()
        .HasIndex(d => d.OrderId)
        .HasDatabaseName("IX_OrderDetails_OrderId");
    
    // è™½ç„¶æ²¡æœ‰å¤–é”®çº¦æŸï¼Œä½†å¯ä»¥é…ç½®å±æ€§æ˜ å°„
    modelBuilder.Entity<OrderDetail>()
        .Property(d => d.OrderId)
        .IsRequired();
    
    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ æ•°æ®åº“å±‚é¢çš„æ£€æŸ¥çº¦æŸï¼ˆå¯é€‰ï¼‰
    modelBuilder.Entity<OrderDetail>()
        .HasCheckConstraint("CK_OrderId_Exists", 
            "EXISTS(SELECT 1 FROM Orders WHERE Id = OrderId)");
}
```

## ğŸ“Š **æ€§èƒ½å¯¹æ¯”**

| æ–¹æ³• | æ•°æ®åº“å¾€è¿”æ¬¡æ•° | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ |
|------|---------------|----------|------|
| **æ–¹æ³•1ï¼šLINQ Join** | 1æ¬¡ | æ•°æ®é‡å¤§ï¼Œéœ€è¦åˆ†é¡µ | â­â­â­â­â­ |
| **æ–¹æ³•2ï¼šåˆ†åˆ«æŸ¥è¯¢** | 2æ¬¡ | ç®€å•æŸ¥è¯¢ï¼Œä»£ç æ¸…æ™° | â­â­â­â­ |
| **æ–¹æ³•3ï¼šåŸç”ŸSQL** | 1æ¬¡ | å¤æ‚æŸ¥è¯¢ï¼Œéœ€è¦ä¼˜åŒ– | â­â­â­â­â­ |
| **æ–¹æ³•4ï¼šæŠ•å½±æŸ¥è¯¢** | 1æ¬¡ | éœ€è¦å¼ºç±»å‹ç»“æœ | â­â­â­â­ |

## ğŸ’¡ **æœ€ä½³å®è·µå»ºè®®**

### **1. åˆ›å»ºæŸ¥è¯¢è¾…åŠ©æ–¹æ³•**
```csharp
public static class QueryExtensions
{
    public static IQueryable<OrderWithDetailsDto> GetOrderWithDetails(
        this IQueryable<Order> orders, 
        IQueryable<OrderDetail> details)
    {
        return orders
            .GroupJoin(
                details,
                order => order.Id,
                detail => detail.OrderId,
                (order, detailList) => new OrderWithDetailsDto
                {
                    Order = order,
                    Details = detailList.ToList()
                });
    }
}

// ä½¿ç”¨
var result = await context.Orders
    .Where(o => o.Id == orderId)
    .GetOrderWithDetails(context.OrderDetails)
    .FirstOrDefaultAsync();
```

### **2. ä½¿ç”¨ Dapper æ··åˆæŸ¥è¯¢**
```csharp
public async Task<OrderWithDetailsDto> GetOrderWithDapper(int orderId)
{
    using var connection = new SqlConnection(connectionString);
    
    var sql = @"
        SELECT * FROM Orders WHERE Id = @OrderId;
        SELECT * FROM OrderDetails WHERE OrderId = @OrderId;";
    
    using var multi = await connection.QueryMultipleAsync(sql, new { OrderId = orderId });
    
    var order = await multi.ReadFirstOrDefaultAsync<Order>();
    var details = (await multi.ReadAsync<OrderDetail>()).ToList();
    
    return new OrderWithDetailsDto { Order = order, Details = details };
}
```

### **3. ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢**
```csharp
public class OrderService
{
    private readonly MemoryCache _cache = new MemoryCache(new MemoryCacheOptions());
    
    public async Task<OrderWithDetailsDto> GetOrderCached(int orderId)
    {
        var cacheKey = $"Order_{orderId}_WithDetails";
        
        return await _cache.GetOrCreateAsync(cacheKey, async entry =>
        {
            entry.AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5);
            
            // ä½¿ç”¨æœ€ç®€å•çš„åˆ†åˆ«æŸ¥è¯¢ï¼Œå› ä¸ºä¼šè¢«ç¼“å­˜
            var order = await context.Orders.FindAsync(orderId);
            var details = await context.OrderDetails
                .Where(d => d.OrderId == orderId)
                .ToListAsync();
            
            return new OrderWithDetailsDto { Order = order, Details = details };
        });
    }
}
```

## ğŸ¯ **æ¨èæ–¹æ¡ˆ**
1. **ç®€å•åœºæ™¯**ï¼šä½¿ç”¨æ–¹æ³•2ï¼ˆåˆ†åˆ«æŸ¥è¯¢ï¼‰ï¼Œä»£ç æœ€æ¸…æ™°
2. **æ€§èƒ½è¦æ±‚é«˜**ï¼šä½¿ç”¨æ–¹æ³•1ï¼ˆLINQ Joinï¼‰æˆ–æ–¹æ³•3ï¼ˆåŸç”ŸSQLï¼‰
3. **å¤æ‚ä¸šåŠ¡**ï¼šåˆ›å»ºä¸“é—¨çš„æŸ¥è¯¢æœåŠ¡ç±»
4. **é¢‘ç¹æŸ¥è¯¢**ï¼šè€ƒè™‘æ·»åŠ ç¼“å­˜å±‚

**é‡è¦æç¤º**ï¼šè™½ç„¶æ²¡æœ‰ä½¿ç”¨å¤–é”®çº¦æŸï¼Œä½†ä¸€å®šè¦ç¡®ä¿ä¸šåŠ¡é€»è¾‘ä¸Šç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¹¶è€ƒè™‘åœ¨æ•°æ®åº“å±‚é¢æ·»åŠ é€‚å½“çš„ç´¢å¼•æ¥ä¿è¯æŸ¥è¯¢æ€§èƒ½ã€‚