# SQL Server å‡½æ•°è¯¦è§£

SQL Server ä¸­çš„å‡½æ•°ä¸»è¦åˆ†ä¸º**æ ‡é‡å‡½æ•°**ã€**èšåˆå‡½æ•°**å’Œ**çª—å£å‡½æ•°**ä¸‰å¤§ç±»ã€‚

---

## ğŸ“Š å¯¹æ¯”æ€»è§ˆ

| ç‰¹æ€§          | æ ‡é‡å‡½æ•°                | èšåˆå‡½æ•°                 | çª—å£å‡½æ•°         |
| ------------- | ----------------------- | ------------------------ | ---------------- |
| **è¿”å›ç»“æœ**  | å•å€¼ï¼ˆæ¯è¡Œï¼‰            | å•å€¼ï¼ˆæ¯ç»„ï¼‰             | å¤šå€¼ï¼ˆæ¯è¡Œï¼‰     |
| **è¡Œæ•°å˜åŒ–**  | ä¸å˜                    | æŠ˜å                      | ä¸å˜             |
| **ä½¿ç”¨ä½ç½®**  | SELECTã€WHEREã€ORDER BY | SELECTã€HAVING           | SELECTã€ORDER BY |
| **åˆ†ç»„æ–¹å¼**  | ä¸åˆ†ç»„                  | GROUP BY                 | PARTITION BY     |
| **NULL å¤„ç†** | å¯èƒ½è¿”å› NULL           | é€šå¸¸å¿½ç•¥ï¼ˆé™¤ COUNT(\*)ï¼‰ | å–å†³äºå‡½æ•°       |
| **æ‰§è¡Œé¡ºåº**  | WHERE ä¹‹å              | GROUP BY ä¹‹å            | SELECT é˜¶æ®µ      |

---

## 1. æ ‡é‡å‡½æ•° (Scalar Functions)

### ç‰¹ç‚¹

- å¯¹å•ä¸ªå€¼è¿›è¡Œæ“ä½œï¼Œè¿”å›å•ä¸ªå€¼
- åœ¨ SELECTã€WHEREã€ORDER BY ç­‰å­å¥ä¸­ä½¿ç”¨
- æ¯è¡Œç‹¬ç«‹è®¡ç®—

### å¸¸è§æ ‡é‡å‡½æ•°ç¤ºä¾‹

```sql
-- å­—ç¬¦ä¸²å‡½æ•°
SELECT UPPER(name), LEN(description) FROM products;

-- æ•°å­¦å‡½æ•°
SELECT ABS(-10), ROUND(price, 2), CEILING(3.14);

-- æ—¥æœŸå‡½æ•°
SELECT GETDATE(), YEAR(order_date), DATEADD(day, 7, order_date);

-- ç±»å‹è½¬æ¢
SELECT CAST(price AS DECIMAL(10,2)), CONVERT(VARCHAR, order_date, 112);
```

---

## 2. èšåˆå‡½æ•° (Aggregate Functions)

### ç‰¹ç‚¹

- å¯¹å¤šè¡Œæ•°æ®è¿›è¡Œè®¡ç®—ï¼Œè¿”å›å•ä¸ªæ±‡æ€»å€¼
- é€šå¸¸ä¸ GROUP BY ä¸€èµ·ä½¿ç”¨
- å¿½ç•¥ NULL å€¼ï¼ˆé™¤éä½¿ç”¨ COUNT(\*)ï¼‰

### å¸¸è§èšåˆå‡½æ•°ç¤ºä¾‹

```sql
-- åŸºæœ¬èšåˆ
SELECT
    COUNT(*) AS total_orders,
    SUM(amount) AS total_amount,
    AVG(amount) AS avg_amount,
    MIN(order_date) AS first_order,
    MAX(order_date) AS last_order
FROM orders;

-- åˆ†ç»„èšåˆ
SELECT
    customer_id,
    COUNT(*) AS order_count,
    SUM(amount) AS total_spent
FROM orders
GROUP BY customer_id;
```

---

## 3. çª—å£å‡½æ•° (Window Functions)

### ç‰¹ç‚¹

- åœ¨ç»“æœé›†çš„çª—å£ï¼ˆåˆ†åŒºï¼‰ä¸Šæ‰§è¡Œè®¡ç®—
- ä¿æŒåŸæœ‰è¡Œæ•°ï¼Œä¸æŠ˜å ç»“æœ
- éœ€è¦ OVER() å­å¥å®šä¹‰çª—å£

### åˆ†ç±»å’Œç¤ºä¾‹

#### æ’åå‡½æ•°

```sql
SELECT
    customer_id,
    order_date,
    amount,
    ROW_NUMBER() OVER (ORDER BY amount DESC) AS row_num,
    RANK() OVER (ORDER BY amount DESC) AS rank,
    DENSE_RANK() OVER (ORDER BY amount DESC) AS dense_rank
FROM orders;
```

#### èšåˆçª—å£å‡½æ•°

```sql
SELECT
    customer_id,
    order_date,
    amount,
    SUM(amount) OVER (PARTITION BY customer_id) AS customer_total,
    AVG(amount) OVER (PARTITION BY customer_id) AS customer_avg,
    SUM(amount) OVER (ORDER BY order_date
                      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total
FROM orders;
```

#### åç§»å‡½æ•°

```sql
SELECT
    customer_id,
    order_date,
    amount,
    LAG(amount, 1) OVER (PARTITION BY customer_id ORDER BY order_date) AS prev_amount,
    LEAD(amount, 1) OVER (PARTITION BY customer_id ORDER BY order_date) AS next_amount,
    FIRST_VALUE(amount) OVER (PARTITION BY customer_id ORDER BY order_date) AS first_amount
FROM orders;
```

---

## ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹

```sql
-- ç»¼åˆä½¿ç”¨ä¸‰ç§å‡½æ•°
SELECT
    customer_id,
    order_date,
    FORMAT(order_date, 'yyyy-MM') AS order_month,  -- æ ‡é‡å‡½æ•°
    amount,
    -- çª—å£å‡½æ•°
    SUM(amount) OVER (PARTITION BY customer_id) AS customer_lifetime_value,
    ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date) AS order_sequence,
    -- èšåˆå‡½æ•°ï¼ˆé€šè¿‡å­æŸ¥è¯¢ï¼‰
    (SELECT AVG(amount) FROM orders WHERE customer_id = o.customer_id) AS customer_avg
FROM orders o
WHERE YEAR(order_date) = 2023  -- æ ‡é‡å‡½æ•°åœ¨WHEREä¸­
ORDER BY customer_id, order_date;
```

---

## âš¡ æ€§èƒ½è€ƒè™‘

1. **æ ‡é‡å‡½æ•°**ï¼šåœ¨ WHERE å­å¥ä¸­å¤§é‡ä½¿ç”¨å¯èƒ½å½±å“æ€§èƒ½
2. **èšåˆå‡½æ•°**ï¼šGROUP BY å¯èƒ½æ¶‰åŠæ’åºå’Œå“ˆå¸Œæ“ä½œ
3. **çª—å£å‡½æ•°**ï¼šéœ€è¦é€‚å½“çš„ç´¢å¼•æ”¯æŒ PARTITION BY å’Œ ORDER BY

---

## ğŸ“ é€‰æ‹©å»ºè®®

- **ä½¿ç”¨æ ‡é‡å‡½æ•°**ï¼šè½¬æ¢æˆ–è®¡ç®—å•ä¸ªå€¼
- **ä½¿ç”¨èšåˆå‡½æ•°**ï¼šè¿›è¡Œåˆ†ç»„æ±‡æ€»ç»Ÿè®¡
- **ä½¿ç”¨çª—å£å‡½æ•°**ï¼šè¿›è¡Œæ’åã€ç´¯ç§¯è®¡ç®—ã€å‰åå€¼æ¯”è¾ƒç­‰åˆ†ææ“ä½œ

> **æç¤º**ï¼šçª—å£å‡½æ•°æ˜¯ SQL Server 2005 åŠä»¥åç‰ˆæœ¬å¼•å…¥çš„å¼ºå¤§åŠŸèƒ½ï¼Œç‰¹åˆ«é€‚åˆå¤æ‚çš„æ•°æ®åˆ†æåœºæ™¯ã€‚

---

## ğŸ”— ç›¸å…³è¯´æ˜

- æ‰€æœ‰å‡½æ•°éƒ½å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œä½†è¦æ³¨æ„æ€§èƒ½å½±å“
- è‡ªå®šä¹‰å‡½æ•°ï¼ˆç”¨æˆ·å®šä¹‰å‡½æ•°ï¼‰ä¹Ÿå±äºè¿™äº›ç±»åˆ«
- ç†è§£å‡½æ•°çš„æ‰§è¡Œé¡ºåºæœ‰åŠ©äºç¼–å†™é«˜æ•ˆçš„æŸ¥è¯¢è¯­å¥

# SQL Server çª—å£å‡½æ•°ç¤ºä¾‹ä¸æµ‹è¯•ç»“æœ

## ğŸ“‹ æµ‹è¯•æ•°æ®å‡†å¤‡

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨å’Œæ•°æ®
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE,
    amount DECIMAL(10,2)
);

INSERT INTO orders VALUES
(1, 101, '2023-01-15', 500.00),
(2, 102, '2023-01-16', 300.00),
(3, 101, '2023-01-17', 500.00),
(4, 103, '2023-01-18', 800.00),
(5, 102, '2023-01-19', 300.00),
(6, 104, '2023-01-20', 200.00),
(7, 103, '2023-01-21', 100.00),
(8, 101, '2023-01-22', 600.00);
```

---

## ğŸ¥‡ 1. æ’åå‡½æ•°ç¤ºä¾‹ç»“æœ

### æ‰§è¡ŒæŸ¥è¯¢

```sql
SELECT
    customer_id,
    order_date,
    amount,
    ROW_NUMBER() OVER (ORDER BY amount DESC) AS row_num,
    RANK() OVER (ORDER BY amount DESC) AS rank,
    DENSE_RANK() OVER (ORDER BY amount DESC) AS dense_rank
FROM orders;
```

### è¿”å›ç»“æœ

| customer_id | order_date | amount | row_num | rank | dense_rank |
| ----------- | ---------- | ------ | ------- | ---- | ---------- |
| 103         | 2023-01-18 | 800.00 | 1       | 1    | 1          |
| 101         | 2023-01-22 | 600.00 | 2       | 2    | 2          |
| 101         | 2023-01-15 | 500.00 | 3       | 3    | 3          |
| 101         | 2023-01-17 | 500.00 | 4       | 3    | 3          |
| 102         | 2023-01-16 | 300.00 | 5       | 5    | 4          |
| 102         | 2023-01-19 | 300.00 | 6       | 5    | 4          |
| 104         | 2023-01-20 | 200.00 | 7       | 7    | 5          |
| 103         | 2023-01-21 | 100.00 | 8       | 8    | 6          |

### ğŸ“ è§£é‡Šè¯´æ˜

| å‡½æ•°             | ç‰¹ç‚¹               | ç¤ºä¾‹è¯´æ˜                                               |
| ---------------- | ------------------ | ------------------------------------------------------ |
| **ROW_NUMBER()** | å”¯ä¸€è¿ç»­ç¼–å·       | å³ä½¿é‡‘é¢ç›¸åŒä¹Ÿåˆ†é…ä¸åŒç¼–å·ï¼ˆ500 å…ƒåˆ†åˆ«æ˜¯ 3 å’Œ 4ï¼‰      |
| **RANK()**       | æœ‰å¹¶åˆ—æ—¶è·³è¿‡åºå·   | ä¸¤ä¸ª 500 å…ƒå¹¶åˆ—ç¬¬ 3ï¼Œä¸‹ä¸€ä¸ª 300 å…ƒç›´æ¥æ˜¯ç¬¬ 5ï¼ˆè·³è¿‡ 4ï¼‰ |
| **DENSE_RANK()** | æœ‰å¹¶åˆ—æ—¶ä¸è·³è¿‡åºå· | ä¸¤ä¸ª 500 å…ƒå¹¶åˆ—ç¬¬ 3ï¼Œä¸‹ä¸€ä¸ª 300 å…ƒæ˜¯ç¬¬ 4ï¼ˆä¸è·³è¿‡ï¼‰     |

---

## ğŸ“ˆ 2. èšåˆçª—å£å‡½æ•°ç¤ºä¾‹ç»“æœ

### æ‰§è¡ŒæŸ¥è¯¢

```sql
SELECT
    customer_id,
    order_date,
    amount,
    SUM(amount) OVER (PARTITION BY customer_id) AS customer_total,
    AVG(amount) OVER (PARTITION BY customer_id) AS customer_avg,
    SUM(amount) OVER (ORDER BY order_date
                      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total
FROM orders;
```

### è¿”å›ç»“æœ

| customer_id | order_date | amount | customer_total | customer_avg | running_total |
| ----------- | ---------- | ------ | -------------- | ------------ | ------------- |
| 101         | 2023-01-15 | 500.00 | 1600.00        | 533.33       | 500.00        |
| 102         | 2023-01-16 | 300.00 | 600.00         | 300.00       | 800.00        |
| 101         | 2023-01-17 | 500.00 | 1600.00        | 533.33       | 1300.00       |
| 103         | 2023-01-18 | 800.00 | 900.00         | 450.00       | 2100.00       |
| 102         | 2023-01-19 | 300.00 | 600.00         | 300.00       | 2400.00       |
| 104         | 2023-01-20 | 200.00 | 200.00         | 200.00       | 2600.00       |
| 103         | 2023-01-21 | 100.00 | 900.00         | 450.00       | 2700.00       |
| 101         | 2023-01-22 | 600.00 | 1600.00        | 533.33       | 3300.00       |

### ğŸ“ è§£é‡Šè¯´æ˜

| å‡½æ•°               | è®¡ç®—é€»è¾‘             | ç»“æœåˆ†æ                                                     |
| ------------------ | -------------------- | ------------------------------------------------------------ |
| **customer_total** | æŒ‰å®¢æˆ·åˆ†åŒºçš„æ€»é‡‘é¢   | customer 101: 500+500+600=1600<br>customer 102: 300+300=600  |
| **customer_avg**   | æŒ‰å®¢æˆ·åˆ†åŒºçš„å¹³å‡é‡‘é¢ | customer 101: 1600/3â‰ˆ533.33<br>customer 103: (800+100)/2=450 |
| **running_total**  | æŒ‰æ—¥æœŸæ’åºçš„ç´¯è®¡æ€»é¢ | éšæ—¶é—´ç´¯ç§¯ï¼š500â†’800â†’1300â†’...â†’3300                            |

---

## ğŸ”„ 3. åç§»å‡½æ•°ç¤ºä¾‹ç»“æœ

### æ‰§è¡ŒæŸ¥è¯¢

```sql
SELECT
    customer_id,
    order_date,
    amount,
    LAG(amount, 1) OVER (PARTITION BY customer_id ORDER BY order_date) AS prev_amount,
    LEAD(amount, 1) OVER (PARTITION BY customer_id ORDER BY order_date) AS next_amount,
    FIRST_VALUE(amount) OVER (PARTITION BY customer_id ORDER BY order_date) AS first_amount
FROM orders;
```

### è¿”å›ç»“æœ

| customer_id | order_date | amount | prev_amount | next_amount | first_amount |
| ----------- | ---------- | ------ | ----------- | ----------- | ------------ |
| 101         | 2023-01-15 | 500.00 | NULL        | 500.00      | 500.00       |
| 101         | 2023-01-17 | 500.00 | 500.00      | 600.00      | 500.00       |
| 101         | 2023-01-22 | 600.00 | 500.00      | NULL        | 500.00       |
| 102         | 2023-01-16 | 300.00 | NULL        | 300.00      | 300.00       |
| 102         | 2023-01-19 | 300.00 | 300.00      | NULL        | 300.00       |
| 103         | 2023-01-18 | 800.00 | NULL        | 100.00      | 800.00       |
| 103         | 2023-01-21 | 100.00 | 800.00      | NULL        | 800.00       |
| 104         | 2023-01-20 | 200.00 | NULL        | NULL        | 200.00       |

### ğŸ“ è§£é‡Šè¯´æ˜

| å‡½æ•°                    | ä½œç”¨                         | ç¤ºä¾‹åˆ†æ                                                            |
| ----------------------- | ---------------------------- | ------------------------------------------------------------------- |
| **LAG(amount, 1)**      | è·å–åŒä¸€å®¢æˆ·ä¸Šä¸€ç¬”è®¢å•çš„é‡‘é¢ | Â· ç¬¬ä¸€ç¬”è®¢å•ï¼šæ²¡æœ‰å‰ä¸€ç¬” â†’ **NULL**<br>Â· åç»­è®¢å•ï¼šæ˜¾ç¤ºå‰ä¸€ç¬”é‡‘é¢   |
| **LEAD(amount, 1)**     | è·å–åŒä¸€å®¢æˆ·ä¸‹ä¸€ç¬”è®¢å•çš„é‡‘é¢ | Â· æœ€åä¸€ç¬”è®¢å•ï¼šæ²¡æœ‰ä¸‹ä¸€ç¬” â†’ **NULL**<br>Â· å‰åºè®¢å•ï¼šæ˜¾ç¤ºä¸‹ä¸€ç¬”é‡‘é¢ |
| **FIRST_VALUE(amount)** | è·å–åŒä¸€å®¢æˆ·ç¬¬ä¸€ç¬”è®¢å•çš„é‡‘é¢ | Â· æ¯ä¸ªå®¢æˆ·åˆ†åŒºéƒ½è¿”å›è¯¥å®¢æˆ·çš„ç¬¬ä¸€ç¬”è®¢å•é‡‘é¢                          |

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### ğŸ“Š çª—å£å‡½æ•°æ ¸å¿ƒç‰¹æ€§

1. **ä¸æ”¹å˜è¡Œæ•°**ï¼šæ‰€æœ‰ç¤ºä¾‹éƒ½è¿”å› 8 è¡Œï¼ˆåŸå§‹æ•°æ®è¡Œæ•°ï¼‰
2. **åˆ†åŒºæ¦‚å¿µ**ï¼š`PARTITION BY` å°†æ•°æ®åˆ†ç»„ä½†ä¸æŠ˜å 
3. **æ’åºå½±å“**ï¼š`ORDER BY` åœ¨çª—å£å‡½æ•°ä¸­å†³å®šè®¡ç®—é¡ºåº
4. **NULL å€¼å¤„ç†**ï¼šLAG/LEAD åœ¨æ²¡æœ‰å‰ä¸€è¡Œ/åä¸€è¡Œæ—¶è¿”å› NULL

### ğŸ’¡ çª—å£å‡½æ•°é€‚ç”¨åœºæ™¯

| åœºæ™¯ç±»å‹         | é€‚ç”¨å‡½æ•°                    | å®é™…åº”ç”¨               |
| ---------------- | --------------------------- | ---------------------- |
| **æ—¶é—´åºåˆ—åˆ†æ** | SUM() OVER, AVG() OVER      | ç´¯è®¡æ€»é¢ã€ç§»åŠ¨å¹³å‡     |
| **æ’åå’Œåˆ†ä½æ•°** | ROW_NUMBER(), RANK()        | é”€å”®æ’åã€æˆç»©æ’å     |
| **æ•°æ®å¯¹æ¯”åˆ†æ** | LAG(), LEAD()               | æœˆåº¦ç¯æ¯”ã€å‰åè®°å½•æ¯”è¾ƒ |
| **è·å–è¾¹ç•Œå€¼**   | FIRST_VALUE(), LAST_VALUE() | è·å–é¦–æœ«è®°å½•           |

---

## ğŸ”§ è¿›é˜¶æç¤º

### çª—å£æ¡†æ¶ï¼ˆWindow Frameï¼‰

```sql
-- è®¡ç®—3å¤©ç§»åŠ¨å¹³å‡
AVG(amount) OVER (
    ORDER BY order_date
    ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
) AS 3_day_moving_avg

-- è®¡ç®—ç´¯è®¡åˆ°å½“å‰è¡Œï¼ˆåŒ…æ‹¬æ‰€æœ‰å‰é¢çš„è¡Œï¼‰
SUM(amount) OVER (
    ORDER BY order_date
    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
) AS cumulative_sum
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. ä¸º `PARTITION BY` å’Œ `ORDER BY` ä¸­çš„åˆ—åˆ›å»ºç´¢å¼•
2. é¿å…åœ¨çª—å£å‡½æ•°ä¸­ä½¿ç”¨å¤æ‚çš„è®¡ç®—è¡¨è¾¾å¼
3. è€ƒè™‘æ•°æ®é‡ï¼Œçª—å£å‡½æ•°åœ¨å¤§é‡æ•°æ®ä¸Šå¯èƒ½è¾ƒæ…¢

---

> **ğŸ“Œ æ³¨æ„**ï¼šçª—å£å‡½æ•°åœ¨ä¿æŒåŸå§‹è¡Œç»“æ„çš„åŒæ—¶æä¾›å¼ºå¤§çš„åˆ†æèƒ½åŠ›ï¼Œæ˜¯ SQL Server ä¸­è¿›è¡Œå¤æ‚æ•°æ®åˆ†æçš„é‡è¦å·¥å…·ã€‚
